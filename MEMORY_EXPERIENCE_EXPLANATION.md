# Memory Experiences 文件结构说明

## 1. 文件结构

`memory_experiences.txt` 文件包含了所有历史运行的经验总结，采用**累积追加**的方式保存。

### 文件组织方式

```
文件内容（按时间顺序，从旧到新）：

[最早的运行] 经验总结1
================================================================================
[经验内容]
================================================================================

[第二次运行] 经验总结2
================================================================================
[经验内容]
================================================================================

...

[最新运行] 经验总结N
================================================================================
[经验内容]
================================================================================
```

## 2. 为什么文件开头有通用经验总结？

### 2.1 文件是累积的

每次运行优化流程时，`MemoryAgent.save_experience()` 方法会**追加**（append mode）新的经验到文件末尾：

```python
def save_experience(self, experience: str):
    """将经验保存到文件"""
    with open(self.memory_file_path, 'a', encoding='utf-8') as f:  # 'a' = append 追加模式
        f.write("=" * 80 + "\n")
        f.write(experience + "\n")
        f.write("=" * 80 + "\n\n")
```

### 2.2 格式演变

文件开头的通用经验总结（第1-29行，第31-57行，第59-86行）是**早期运行版本**生成的，格式较简单：

```
### Prompt优化通用经验总结

1. **核心要点**：...
2. **带来准确率提升的更改**：...
3. **通用优化原则**：...
4. **未来应用建议**：...
```

后面详细的经验总结（从第88行开始）是**新版本**生成的，格式更详细，包含：

```
### 第 X 轮优化经验总结

#### 1. **迭代轮次**：第 X 轮
#### 2. **更改内容**：...
#### 3. **准确率变化**：...
#### 4. **案例变化分析**：...
#### 5. **后续优化建议**：...
```

### 2.3 为什么保留所有历史经验？

**优点**：

1. **完整历史记录**：可以看到优化过程的完整演进
2. **经验累积**：所有历史经验都会被 `load_experiences()` 加载，供 rewrite agent 参考
3. **对比分析**：可以对比不同版本的经验总结，了解优化趋势
4. **知识保留**：即使格式不同，早期经验仍然有价值

## 3. 经验的使用方式

### 3.1 加载经验

每次运行开始时，会加载**所有历史经验**：

```python
memory_experiences = self.memory_agent.load_experiences()  # 读取整个文件
```

### 3.2 传递给 Rewrite Agent

所有经验（包括早期通用经验和新版详细经验）都会被传递给 rewrite agent：

```python
new_prompt = self.rewrite_agent.rewrite(
    original_prompt,
    analysis,
    iteration,
    memory_experiences  # 包含所有历史经验
)
```

### 3.3 Rewrite Agent 如何使用

Rewrite agent 会在 prompt 中包含历史经验：

```
原始 Prompt: ...
分析结果: ...
改进建议: ...

历史优化经验:
[所有历史经验内容，包括通用经验和详细经验]

请参考这些经验来改进 prompt。
```

## 4. 经验总结的格式演变

### 4.1 早期版本（文件开头）

- ✅ 格式简洁
- ✅ 通用性强
- ✅ 原则导向
- ❌ 缺少具体案例
- ❌ 缺少准确率变化详情

### 4.2 新版本（文件后面）

- ✅ 包含迭代轮次
- ✅ 详细的更改内容说明
- ✅ 准确的准确率变化数据
- ✅ 具体的案例变化分析
- ✅ 针对性的优化建议

## 5. 为什么这样设计很好？

### 5.1 知识累积

- 早期经验：提供通用的优化原则和方向
- 新经验：提供具体的案例和详细分析
- 两者结合：既有通用指导，又有具体参考

### 5.2 渐进式优化

- 可以看到优化过程的演进
- 早期经验为后续优化提供基础
- 新经验补充和细化早期经验

### 5.3 灵活性

- 不需要删除旧经验
- 所有经验都会被考虑
- LLM 可以自主选择最有价值的信息

## 6. 总结

文件开头的通用经验总结是**之前运行生成的早期版本**，它们：

1. ✅ **被保留**：因为文件使用追加模式（append），所有历史经验都保留
2. ✅ **会被使用**：`load_experiences()` 会加载整个文件，包括早期经验
3. ✅ **有价值**：虽然格式简单，但包含通用的优化原则，对新优化有参考价值
4. ✅ **格式演变**：反映了系统功能的不断完善和优化

这种设计让系统能够：
- 📚 **累积知识**：所有历史经验都保留
- 🔄 **持续学习**：每次优化都基于所有历史经验
- 📈 **渐进改进**：可以看到优化过程的完整演进

